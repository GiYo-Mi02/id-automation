<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capture Station | Rimberio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { slate: { 850: '#151e32', 900: '#0f172a', 950: '#020617' } },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    <style>
        video { transform: scaleX(-1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .clean-bottom-edge {
            mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-50 h-screen flex overflow-hidden font-sans">

    <aside class="w-24 bg-slate-900 border-r border-slate-800 flex flex-col items-center py-6 z-20 shrink-0">
        <nav class="flex flex-col gap-6 w-full px-2">
            <a href="/" class="group flex flex-col items-center justify-center p-3 rounded-xl bg-blue-600 text-white shadow-lg shadow-blue-900/50 transition-all transform hover:scale-105">
                <i class="ph-bold ph-camera text-2xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-wide">CAPTURE</span>
            </a>
            <a href="/dashboard" class="group flex flex-col items-center justify-center p-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                <i class="ph-bold ph-squares-four text-2xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-wide">ADMIN</span>
            </a>
            <a href="/editor" class="group flex flex-col items-center justify-center p-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                <i class="ph-bold ph-pencil-ruler text-2xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-wide">EDITOR</span>
            </a>
        </nav>
    </aside>

    <main class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 p-6 h-full overflow-hidden">
        
        <section class="lg:col-span-8 flex flex-col gap-4 h-full">
            <div class="flex justify-between items-center bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-sm">
                <h1 class="text-xl font-bold flex items-center gap-2 text-white">
                    <i class="ph-fill ph-aperture text-blue-500"></i> Live Capture
                </h1>
                
                <div class="flex items-center gap-3">
                    <button onclick="toggleGuide()" id="guideBtn" class="flex items-center gap-2 px-3 py-1.5 bg-blue-500/10 text-blue-400 border border-blue-500/20 rounded-lg hover:bg-blue-500/20 transition-colors text-xs font-bold uppercase tracking-wider">
                        <i class="ph-bold ph-bounding-box"></i> Toggle Guide
                    </button>
                    <div id="status" class="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded-full text-xs font-medium text-slate-400 border border-slate-700">
                        <span class="relative flex h-2.5 w-2.5">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-slate-500"></span>
                        </span>
                        Connecting...
                    </div>
                </div>
            </div>

            <div class="flex-1 bg-black rounded-2xl border-2 border-slate-800 relative overflow-hidden shadow-2xl flex items-center justify-center group">
                <video id="liveVideo" autoplay playsinline muted class="w-full h-full object-cover opacity-90 transition-opacity"></video>
                <div id="cameraOverlay" class="absolute inset-0 pointer-events-none flex items-end justify-center pb-0 opacity-40 transition-opacity duration-300">
                    <svg viewBox="0 0 400 600" class="h-[90%] w-auto drop-shadow-2xl" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="10" y="10" width="380" height="580" rx="20" stroke="white" stroke-width="2" stroke-dasharray="10 10" stroke-opacity="0.5"/>
                        <circle cx="200" cy="200" r="90" stroke="white" stroke-width="4" stroke-opacity="0.8" fill="rgba(255,255,255,0.1)"/>
                        <path d="M60 600 V 480 Q 60 380 200 380 Q 340 380 340 480 V 600" stroke="white" stroke-width="4" stroke-opacity="0.8" fill="rgba(255,255,255,0.1)"/>
                        <line x1="200" y1="50" x2="200" y2="100" stroke="white" stroke-width="2" stroke-opacity="0.5"/>
                    </svg>
                </div>
            </div>

            <div class="bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-lg grid grid-cols-1 md:grid-cols-12 gap-4">
                
                <div class="md:col-span-3">
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Camera</label>
                    <div class="relative">
                        <select id="cameraSource" class="w-full h-12 bg-slate-950 border border-slate-700 text-white text-sm rounded-lg focus:ring-2 focus:ring-blue-500 block p-2.5 appearance-none cursor-pointer">
                            <option>Detecting...</option>
                        </select>
                        <i class="ph-bold ph-caret-down absolute right-3 top-3.5 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                
                <div class="md:col-span-6 flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Student Details</label>
                        <div class="flex bg-slate-950 rounded-lg p-0.5 border border-slate-700">
                            <button onclick="setInputMode('db')" id="tab-db" class="px-3 py-0.5 text-[10px] font-bold uppercase rounded-md bg-blue-600 text-white shadow-sm transition-all">Database</button>
                            <button onclick="setInputMode('manual')" id="tab-manual" class="px-3 py-0.5 text-[10px] font-bold uppercase rounded-md text-slate-400 hover:text-white transition-all">Manual</button>
                        </div>
                    </div>

                    <div id="input-db" class="relative">
                        <i class="ph-bold ph-magnifying-glass absolute left-3 top-3.5 text-slate-500"></i>
                        <input list="studentList" id="studentInput" class="w-full h-12 bg-slate-950 border border-slate-700 text-white text-sm rounded-lg focus:ring-2 focus:ring-blue-500 block pl-10 p-2.5 placeholder-slate-500" placeholder="Search Database...">
                        <datalist id="studentList"></datalist>
                    </div>

                    <div id="input-manual" class="hidden grid-cols-2 gap-2 overflow-y-auto max-h-[120px] pr-1 no-scrollbar">
                        <input id="manualId" class="col-span-2 h-10 bg-slate-950 border border-slate-700 text-white text-sm rounded-lg px-3 focus:ring-2 focus:ring-blue-500" placeholder="ID Number (Required)">
                        <input id="manualName" class="col-span-2 h-10 bg-slate-950 border border-slate-700 text-white text-sm rounded-lg px-3 focus:ring-2 focus:ring-blue-500" placeholder="Full Name (Required)">
                        
                        <input id="manualGrade" class="col-span-1 h-10 bg-slate-950 border border-slate-700 text-white text-xs rounded-lg px-3 focus:ring-2 focus:ring-blue-500" placeholder="Grade Level">
                        <input id="manualSection" class="col-span-1 h-10 bg-slate-950 border border-slate-700 text-white text-xs rounded-lg px-3 focus:ring-2 focus:ring-blue-500" placeholder="Section">
                        
                        <input id="manualGuardian" class="col-span-2 h-10 bg-slate-950 border border-slate-700 text-white text-xs rounded-lg px-3 focus:ring-2 focus:ring-blue-500" placeholder="Guardian Name">
                        <input id="manualAddress" class="col-span-1 h-10 bg-slate-950 border border-slate-700 text-white text-xs rounded-lg px-3 focus:ring-2 focus:ring-blue-500" placeholder="Address">
                        <input id="manualContact" class="col-span-1 h-10 bg-slate-950 border border-slate-700 text-white text-xs rounded-lg px-3 focus:ring-2 focus:ring-blue-500" placeholder="Contact No.">
                    </div>
                </div>

                <div class="md:col-span-3 flex flex-col justify-end">
                    <button id="captureBtn" onclick="capturePhoto()" class="w-full h-12 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg shadow-blue-900/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                        <i class="ph-bold ph-camera-plus text-lg"></i>
                        <span>CAPTURE</span>
                    </button>
                </div>
            </div>
        </section>

        <section class="lg:col-span-4 bg-slate-900 rounded-2xl border border-slate-800 flex flex-col overflow-hidden h-full shadow-sm">
            <div class="p-5 border-b border-slate-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-10">
                <h2 class="text-lg font-bold flex items-center gap-2 text-white">
                    <i class="ph-bold ph-clock-counter-clockwise text-slate-400"></i> Recent History
                </h2>
            </div>
            <div id="historyList" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar"></div>
        </section>
    </main>

    <div id="resultOverlay" class="fixed inset-0 z-50 bg-black/90 backdrop-blur-md hidden flex-col items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="absolute top-6 right-6 z-50">
            <button onclick="closeOverlay()" class="bg-slate-800 text-white p-3 rounded-full hover:bg-slate-700 transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
        </div>
        <div class="text-center mb-6 animate-fade-in-down">
            <h2 class="text-2xl font-bold text-white tracking-tight flex items-center gap-2 justify-center"><i class="ph-fill ph-cards text-blue-500"></i> Generated ID Cards</h2>
        </div>
        <div class="flex flex-col md:flex-row gap-8 max-w-6xl w-full px-6 justify-center items-center" id="resultCards"></div>
    </div>

    <script>
        const API_URL = ""; 
        const WS_URL = "ws://" + window.location.host + "/ws";
        let studentsMap = {};
        let guideVisible = true;
        let inputMode = 'db'; 

        async function init() {
            loadStudents();
            loadHistory();
            initCamera();
            initWebSocket();
        }

        function setInputMode(mode) {
            inputMode = mode;
            const tabDb = document.getElementById('tab-db');
            const tabMan = document.getElementById('tab-manual');
            const containerDb = document.getElementById('input-db');
            const containerMan = document.getElementById('input-manual');

            if (mode === 'db') {
                tabDb.className = "px-3 py-0.5 text-[10px] font-bold uppercase rounded-md bg-blue-600 text-white shadow-sm transition-all";
                tabMan.className = "px-3 py-0.5 text-[10px] font-bold uppercase rounded-md text-slate-400 hover:text-white transition-all";
                containerDb.classList.remove('hidden');
                containerMan.classList.add('hidden');
                containerMan.classList.remove('grid');
            } else {
                tabDb.className = "px-3 py-0.5 text-[10px] font-bold uppercase rounded-md text-slate-400 hover:text-white transition-all";
                tabMan.className = "px-3 py-0.5 text-[10px] font-bold uppercase rounded-md bg-blue-600 text-white shadow-sm transition-all";
                containerDb.classList.add('hidden');
                containerMan.classList.remove('hidden');
                containerMan.classList.add('grid');
            }
        }

        function toggleGuide() {
            const overlay = document.getElementById('cameraOverlay');
            const btn = document.getElementById('guideBtn');
            guideVisible = !guideVisible;
            if(guideVisible) {
                overlay.classList.remove('opacity-0'); overlay.classList.add('opacity-40');
                btn.classList.add('bg-blue-500/10', 'text-blue-400'); btn.classList.remove('bg-slate-800', 'text-slate-400');
            } else {
                overlay.classList.remove('opacity-40'); overlay.classList.add('opacity-0');
                btn.classList.remove('bg-blue-500/10', 'text-blue-400'); btn.classList.add('bg-slate-800', 'text-slate-400');
            }
        }

        async function loadStudents() {
            try {
                const res = await fetch(`${API_URL}/students`);
                const data = await res.json();
                const datalist = document.getElementById('studentList');
                datalist.innerHTML = '';
                studentsMap = {};
                data.forEach(s => {
                    const id = s.id_number || s.ID_Number;
                    const name = s.full_name || s.Full_Name;
                    studentsMap[`${id} - ${name}`] = id; 
                    const opt = document.createElement('option');
                    opt.value = `${id} - ${name}`;
                    datalist.appendChild(opt);
                });
            } catch(e) {}
        }

        async function loadHistory() {
            try {
                const res = await fetch(`${API_URL}/history`);
                const data = await res.json();
                document.getElementById('historyList').innerHTML = ''; 
                data.forEach(item => addToHistory(item.student_id, item.front_url, item.back_url, false));
            } catch(e) {}
        }

        function initWebSocket() {
            const ws = new WebSocket(WS_URL);
            const statusBadge = document.getElementById('status');
            ws.onopen = () => { 
                statusBadge.innerHTML = `<span class="h-2.5 w-2.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></span> Online`;
                statusBadge.className = "flex items-center gap-2 px-3 py-1.5 bg-green-500/10 rounded-full text-xs font-bold text-green-400 border border-green-500/20";
            };
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'new_id') {
                    showImages(data.front_url, data.back_url);
                    const btn = document.getElementById('captureBtn');
                    btn.disabled = false; 
                    btn.innerHTML = `<i class="ph-bold ph-camera-plus text-lg"></i><span>CAPTURE</span>`;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    addToHistory(data.student_id, data.front_url, data.back_url, true);
                }
            };
            ws.onclose = () => { 
                statusBadge.innerHTML = `<span class="h-2.5 w-2.5 rounded-full bg-red-500"></span> Offline`;
                statusBadge.className = "flex items-center gap-2 px-3 py-1.5 bg-red-500/10 rounded-full text-xs font-bold text-red-400 border border-red-500/20";
                setTimeout(initWebSocket, 2000); 
            };
        }

        function addToHistory(id, frontUrl, backUrl, prepend) {
            const list = document.getElementById('historyList');
            const div = document.createElement('div');
            div.className = "flex items-center gap-4 p-3 bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 rounded-xl transition-colors cursor-pointer group";
            div.onclick = () => showImages(frontUrl, backUrl);
            let displayUrl = frontUrl;
            if (frontUrl && !frontUrl.startsWith("http") && !frontUrl.startsWith("/")) {
                 const filename = frontUrl.split('\\').pop().split('/').pop();
                 displayUrl = `/output/${filename}`;
            }
            div.innerHTML = `
                <div class="relative w-12 h-12 shrink-0">
                    <img src="${displayUrl}" class="w-full h-full object-cover rounded-lg border border-slate-600 bg-slate-900 clean-bottom-edge" onerror="this.src='https://placehold.co/60x60/1e293b/FFF?text=IMG'">
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-white truncate group-hover:text-blue-400 transition-colors">${id}</p>
                    <p class="text-xs text-slate-500 truncate">Click to view</p>
                </div>
                <i class="ph-bold ph-eye text-slate-600 group-hover:text-blue-400"></i>
            `;
            if (prepend) list.insertBefore(div, list.firstChild); else list.appendChild(div);
        }

        function showImages(front, back) {
            const ts = Date.now();
            const fUrl = `${front}?t=${ts}`;
            const bUrl = `${back}?t=${ts}`;
            const cardsContainer = document.getElementById('resultCards');
            cardsContainer.innerHTML = `
                <div class="flex flex-col items-center gap-2">
                    <span class="text-slate-400 text-sm font-bold uppercase tracking-wider">Front Side</span>
                    <img src="${fUrl}" class="h-[65vh] rounded-xl shadow-2xl border border-slate-700 hover:scale-[1.02] transition-transform duration-300 clean-bottom-edge">
                </div>
                <div class="flex flex-col items-center gap-2">
                    <span class="text-slate-400 text-sm font-bold uppercase tracking-wider">Back Side</span>
                    <img src="${bUrl}" class="h-[65vh] rounded-xl shadow-2xl border border-slate-700 hover:scale-[1.02] transition-transform duration-300">
                </div>
            `;
            const overlay = document.getElementById('resultOverlay');
            overlay.classList.remove('hidden', 'opacity-0'); overlay.classList.add('flex', 'opacity-100');
        }

        function closeOverlay() {
            const overlay = document.getElementById('resultOverlay');
            overlay.classList.remove('opacity-100'); overlay.classList.add('opacity-0');
            setTimeout(() => { overlay.classList.remove('flex'); overlay.classList.add('hidden'); }, 300);
        }

        async function initCamera() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                const sel = document.getElementById('cameraSource');
                sel.innerHTML = '';
                videoDevices.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.deviceId; opt.text = d.label || `Camera ${sel.options.length + 1}`; sel.appendChild(opt);
                });
                startStream(videoDevices[0]?.deviceId);
                sel.onchange = (e) => startStream(e.target.value);
            } catch(e) {}
        }

        async function startStream(deviceId) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: deviceId ? { exact: deviceId } : undefined, width: { ideal: 1920 }, height: { ideal: 1080 } } });
                document.getElementById('liveVideo').srcObject = stream;
            } catch (e) {
                const fallback = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('liveVideo').srcObject = fallback;
            }
        }

        async function capturePhoto() {
            const video = document.getElementById('liveVideo');
            const formData = new FormData();
            
            if (inputMode === 'db') {
                const inputVal = document.getElementById('studentInput').value;
                let id = studentsMap[inputVal] || inputVal.split(' - ')[0];
                if (!id || inputVal.trim() === '') return alert("Please select a student.");
                formData.append('student_id', id);
            } else {
                const mId = document.getElementById('manualId').value.trim();
                const mName = document.getElementById('manualName').value.trim();
                
                if (!mId || !mName) return alert("ID and Name are required.");
                
                formData.append('student_id', mId);
                formData.append('manual_name', mName);
                formData.append('manual_grade', document.getElementById('manualGrade').value.trim());
                formData.append('manual_section', document.getElementById('manualSection').value.trim());
                // SENDING BACK ID INFO NOW
                formData.append('manual_guardian', document.getElementById('manualGuardian').value.trim());
                formData.append('manual_address', document.getElementById('manualAddress').value.trim());
                formData.append('manual_contact', document.getElementById('manualContact').value.trim());
            }
            
            const btn = document.getElementById('captureBtn');
            btn.disabled = true; 
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.innerHTML = `<i class="ph-bold ph-spinner ph-spin text-lg"></i><span>PROCESSING...</span>`;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            canvas.toBlob(async (blob) => {
                formData.append('file', blob, "capture.jpg");
                await fetch(`${API_URL}/capture`, { method: 'POST', body: formData });
            }, 'image/jpeg');
        }

        init();
    </script>
</body>
</html>
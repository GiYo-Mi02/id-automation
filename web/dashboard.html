<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Rimberio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { slate: { 850: '#151e32', 900: '#0f172a', 950: '#020617' } }
                }
            }
        }
    </script>
    <style>.no-scrollbar::-webkit-scrollbar { display: none; }</style>
</head>
<body class="bg-slate-950 text-slate-50 h-screen flex overflow-hidden font-sans">

    <aside class="w-24 bg-slate-900 border-r border-slate-800 flex flex-col items-center py-6 z-20 shrink-0">
        <nav class="flex flex-col gap-6 w-full px-2">
            <a href="/" class="group flex flex-col items-center justify-center p-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                <i class="ph-bold ph-camera text-2xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-wide">CAPTURE</span>
            </a>
            <a href="/dashboard" class="group flex flex-col items-center justify-center p-3 rounded-xl bg-blue-600 text-white shadow-lg shadow-blue-900/50 transition-all transform hover:scale-105">
                <i class="ph-bold ph-squares-four text-2xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-wide">ADMIN</span>
            </a>
            <a href="/editor" class="group flex flex-col items-center justify-center p-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                <i class="ph-bold ph-pencil-ruler text-2xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-wide">EDITOR</span>
            </a>
        </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto no-scrollbar">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-white">System Dashboard</h1>
            <div class="text-sm text-slate-400 bg-slate-900 px-4 py-2 rounded-lg border border-slate-800">
                Logged in as Admin
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            <div class="space-y-8">
                <div class="bg-slate-900 rounded-2xl border border-slate-800 p-6 shadow-sm">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex justify-between">Front Designs</h3>
                    <div class="grid grid-cols-3 gap-3 mb-4" id="frontTemplateList"></div>
                    <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-slate-700 border-dashed rounded-xl cursor-pointer hover:bg-slate-800 hover:border-blue-500 transition-colors group">
                        <i class="ph-bold ph-upload-simple text-2xl text-slate-500 group-hover:text-blue-400"></i>
                        <input type="file" id="uploadFront" accept="image/png" class="hidden" onchange="uploadTemplate('front')">
                    </label>
                </div>
                <div class="bg-slate-900 rounded-2xl border border-slate-800 p-6 shadow-sm">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Back Designs</h3>
                    <div class="grid grid-cols-3 gap-3 mb-4" id="backTemplateList"></div>
                    <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-slate-700 border-dashed rounded-xl cursor-pointer hover:bg-slate-800 hover:border-blue-500 transition-colors group">
                        <i class="ph-bold ph-upload-simple text-2xl text-slate-500 group-hover:text-blue-400"></i>
                        <input type="file" id="uploadBack" accept="image/png" class="hidden" onchange="uploadTemplate('back')">
                    </label>
                </div>
            </div>

            <div class="xl:col-span-2 space-y-8">
                <div class="bg-slate-900 rounded-2xl border border-slate-800 p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="ph-fill ph-eye text-blue-500"></i> Latest Output</h3>
                        <button onclick="forceRefreshPreview()" class="text-sm flex items-center gap-2 text-slate-400 hover:text-white transition-colors bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg border border-slate-700"><i class="ph-bold ph-arrows-clockwise"></i> Refresh</button>
                    </div>
                    <div class="bg-black rounded-xl border border-slate-800 p-8 flex flex-wrap justify-center items-center gap-8 min-h-[350px]" id="livePreview">
                        <div class="text-slate-500 flex flex-col items-center animate-pulse"><i class="ph-bold ph-image text-4xl mb-2"></i><span>Waiting...</span></div>
                    </div>
                </div>

                <div class="bg-slate-900 rounded-2xl border border-slate-800 flex flex-col shadow-sm h-[400px]">
                    <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white">Student Database</h3>
                        <button onclick="loadHistory()" class="text-slate-400 hover:text-blue-400 transition-colors"><i class="ph-bold ph-arrow-clockwise text-xl"></i></button>
                    </div>
                    <div class="overflow-auto flex-1 p-0">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-950 sticky top-0 z-10 text-xs font-bold uppercase text-slate-500 tracking-wider">
                                <tr>
                                    <th class="p-4 border-b border-slate-800">Time</th>
                                    <th class="p-4 border-b border-slate-800">ID Number</th>
                                    <th class="p-4 border-b border-slate-800">Student Name</th>
                                    <th class="p-4 border-b border-slate-800 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable" class="text-sm divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="viewModal" class="fixed inset-0 z-50 bg-black/90 backdrop-blur-md hidden flex-col items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="absolute top-6 right-6">
            <button onclick="closeView()" class="bg-slate-800 text-white p-3 rounded-full hover:bg-slate-700"><i class="ph-bold ph-x text-xl"></i></button>
        </div>
        <div class="flex flex-col md:flex-row gap-8 max-w-6xl w-full px-6 justify-center items-center" id="viewImagesContainer"></div>
    </div>

    <div id="editModal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-2xl rounded-2xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col">
            <div class="p-6 border-b border-slate-800 bg-slate-800/50"><h2 class="text-xl font-bold text-white">Edit Student</h2></div>
            <div class="p-6 space-y-4 overflow-y-auto max-h-[70vh]">
                <input type="hidden" id="editId">
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Name</label><input id="editName" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Grade</label><input id="editGrade" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white"></div>
                    <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Section</label><input id="editSection" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Guardian</label><input id="editGuardian" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white"></div>
                    <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Contact</label><input id="editContact" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white"></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Address</label><input id="editAddress" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white"></div>
            </div>
            <div class="p-6 border-t border-slate-800 bg-slate-800/30 flex justify-end gap-3">
                <button onclick="toggleModal('editModal', false)" class="px-6 py-2.5 rounded-lg border border-slate-600 text-slate-300 hover:bg-slate-800">Cancel</button>
                <button onclick="saveAndRegenerate()" class="px-6 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold">Save & Regenerate</button>
            </div>
        </div>
    </div>

    <script>
        let settings = {};
        let latestId = null;

        async function init() {
            await loadSettings();
            await loadTemplates();
            loadHistory();
            initWebSocket();
            fetch('/history').then(r=>r.json()).then(data => {
                if(data.length > 0) {
                    latestId = data[0].student_id;
                    updateLivePreview(data[0].front_url, data[0].back_url);
                }
            });
        }

        async function loadSettings() { try { const res = await fetch('/settings'); settings = await res.json(); } catch(e){} }
        
        async function loadTemplates() { 
            try { 
                const res = await fetch('/templates/list'); 
                const files = await res.json(); 
                renderTemplateList('front', files, settings.active_template_front); 
                renderTemplateList('back', files, settings.active_template_back); 
            } catch(e){} 
        }
        
        function renderTemplateList(type, files, active) {
            const container = document.getElementById(type + 'TemplateList'); 
            container.innerHTML = '';
            files.forEach(f => {
                const isActive = f === active;
                const div = document.createElement('div'); 
                div.className = `relative aspect-[2/3] rounded-lg overflow-hidden border-2 cursor-pointer transition-all hover:-translate-y-1 ${isActive ? 'border-blue-500 ring-2 ring-blue-500/30' : 'border-transparent opacity-60 hover:opacity-100 hover:border-slate-500'}`;
                div.innerHTML = `<img src="/templates/${f}" class="w-full h-full object-cover">`;
                div.onclick = () => { 
                    if(type === 'front') settings.active_template_front = f; 
                    else settings.active_template_back = f; 
                    saveSettings(); 
                    loadTemplates(); 
                };
                container.appendChild(div);
            });
        }
        
        async function saveSettings() { await fetch('/settings', { method: 'POST', body: JSON.stringify(settings) }); }
        
        async function uploadTemplate(type) {
            const fileInput = document.getElementById(type === 'front' ? 'uploadFront' : 'uploadBack');
            if(!fileInput.files[0]) return; 
            const formData = new FormData(); 
            formData.append('file', fileInput.files[0]);
            await fetch('/templates/upload', { method: 'POST', body: formData }); 
            loadTemplates(); 
        }

        async function loadHistory() {
            try {
                const res = await fetch('/history'); 
                const data = await res.json();
                const tbody = document.getElementById('historyTable'); 
                tbody.innerHTML = '';
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-800/50 transition-colors group";
                    tr.innerHTML = `
                        <td class="p-4 text-slate-500 font-mono text-xs">${new Date(row.timestamp).toLocaleTimeString()}</td>
                        <td class="p-4 font-bold text-white group-hover:text-blue-400">${row.student_id}</td>
                        <td class="p-4 text-slate-300">${row.full_name||'Unknown'}</td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            <button class="text-xs font-medium bg-blue-900/30 hover:bg-blue-900/50 border border-blue-800 text-blue-300 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1" 
                                onclick="openView('${row.front_url}', '${row.back_url}')">
                                <i class="ph-bold ph-eye"></i> View
                            </button>
                            <button class="text-xs font-medium bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white px-3 py-1.5 rounded-lg transition-colors" 
                                onclick="openEdit('${row.student_id}','${row.full_name||''}','${row.grade_level||''}','${row.section||''}','${row.guardian_name||''}','${row.address||''}','${row.guardian_contact||''}')">
                                Edit
                            </button> 
                        </td>`;
                    tbody.appendChild(tr);
                });
            } catch(e){}
        }

        // --- NEW VIEW MODAL LOGIC ---
        function openView(front, back) {
            const ts = Date.now();
            const container = document.getElementById('viewImagesContainer');
            container.innerHTML = `
                <img src="${front}?t=${ts}" class="h-[70vh] rounded-lg shadow-2xl border border-slate-700">
                <img src="${back}?t=${ts}" class="h-[70vh] rounded-lg shadow-2xl border border-slate-700">
            `;
            const m = document.getElementById('viewModal');
            m.classList.remove('hidden', 'opacity-0');
            m.classList.add('flex', 'opacity-100');
        }

        function closeView() {
            const m = document.getElementById('viewModal');
            m.classList.remove('opacity-100');
            m.classList.add('opacity-0');
            setTimeout(() => { m.classList.add('hidden'); m.classList.remove('flex'); }, 300);
        }

        function updateLivePreview(frontUrl, backUrl) {
            const container = document.getElementById('livePreview');
            const ts = Date.now();
            container.innerHTML = `
                <img src="${frontUrl}?t=${ts}" class="h-[300px] rounded-lg shadow-2xl border border-slate-700">
                <img src="${backUrl}?t=${ts}" class="h-[300px] rounded-lg shadow-2xl border border-slate-700">
            `;
        }

        function forceRefreshPreview() {
            if(latestId) updateLivePreview(`/output/${latestId}_FRONT.png`, `/output/${latestId}_BACK.png`);
            loadHistory();
        }

        function toggleModal(id, show) {
            const m = document.getElementById(id);
            if(show) { m.classList.remove('hidden'); m.classList.add('flex'); }
            else { m.classList.add('hidden'); m.classList.remove('flex'); }
        }

        function openEdit(id, name, grade, section, guard, addr, cont) {
            document.getElementById('editId').value = id;
            document.getElementById('editName').value = name;
            document.getElementById('editGrade').value = grade;    
            document.getElementById('editSection').value = section;
            document.getElementById('editGuardian').value = guard;
            document.getElementById('editAddress').value = addr;
            document.getElementById('editContact').value = cont;
            toggleModal('editModal', true);
        }
        
        async function saveAndRegenerate() {
            const id = document.getElementById('editId').value;
            const data = { 
                id: id, name: document.getElementById('editName').value, 
                grade_level: document.getElementById('editGrade').value, 
                section: document.getElementById('editSection').value, 
                guardian_name: document.getElementById('editGuardian').value, 
                address: document.getElementById('editAddress').value, 
                guardian_contact: document.getElementById('editContact').value 
            };
            await fetch('/students/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            const res = await fetch(`/regenerate/${id}`, { method: 'POST' });
            if(res.ok) { toggleModal('editModal', false); loadHistory(); latestId = id; forceRefreshPreview(); } 
            else { alert("Error: Cannot regenerate."); }
        }

        function initWebSocket() {
            const ws = new WebSocket("ws://" + window.location.host + "/ws");
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'new_id') {
                    latestId = data.student_id;
                    updateLivePreview(data.front_url, data.back_url);
                    loadHistory(); 
                }
            };
            ws.onclose = () => setTimeout(initWebSocket, 2000);
        }

        init();
    </script>
</body>
</html>